<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>jquery.spa.js</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>jquery.spa.js</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cm">/*</span>
<span class="cm"> *             mm###########mmm</span>
<span class="cm"> *          m####################m</span>
<span class="cm"> *        m#####`&quot;#m m###&quot;&quot;&quot;&#39;######m</span>
<span class="cm"> *       ######*&quot;  &quot;   &quot;   &quot;mm#######</span>
<span class="cm"> *     m####&quot;  ,             m&quot;#######m       SPA (Single Page App) / jQuery</span>
<span class="cm"> *    m#### m*&quot; ,&#39;  ;     ,   &quot;########m      </span>
<span class="cm"> *    ####### m*   m  |#m  ;  m ########      https://github.com/dejanstrbac/spa</span>
<span class="cm"> *   |######### mm#  |####  #m##########|</span>
<span class="cm"> *    ###########|  |######m############</span>
<span class="cm"> *    &quot;##########|  |##################&quot;</span>
<span class="cm"> *     &quot;#########  |## /##############&quot;</span>
<span class="cm"> *       ########|  # |/ m###########</span>
<span class="cm"> *        &quot;#######      ###########&quot;</span>
<span class="cm"> *          &quot;&quot;&quot;&quot;&quot;&quot;       &quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;</span>
<span class="cm"> */</span>

<span class="p">;(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">$</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">spa</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">spa</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Start by memoizing the container element. By attaching to the container,
multiple containers &amp; spa apps should be theoretically supported, while
they would have to share URL namespace and routes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">containerElement</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Previous app state is saved given in the request to the controller as
aid for context determination. In most cases it is not needed or used,
but could be helpful for having a &ldquo;last seen products&rdquo; etc.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">previousHash</span>   <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> 
        <span class="nx">previousParams</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> </pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>When hash listeners are not supported in older
browsers, we will poll for hash changes every 333 milliseconds.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">pollingInterval</span> <span class="o">=</span> <span class="mi">333</span><span class="p">,</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>The SPA app logic is contained in the following objects. Contents
are injected via public interfaces.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">routes</span>      <span class="o">=</span> <span class="p">[],</span>        
        <span class="nx">controllers</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">callbacks</span>   <span class="o">=</span> <span class="p">{},</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>All templates are stored in memory so no repetitive DOM access is needed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">templatesMemo</span> <span class="o">=</span> <span class="p">{</span>         
          <span class="s1">&#39;404&#39;</span><span class="o">:</span> <span class="s1">&#39;&lt;h1&gt;404 Page not found&lt;/h1&gt;&#39;</span>
        <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Helper memo for aiding memoization in helpers and controllers,
so extraction  from payload is optimized.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">objectsMemo</span> <span class="o">=</span> <span class="p">{},</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>There is quite a lot of stuff happening within SPA, although fairly
simple. Having some logging in development mode might be helpful.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">debugging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Simple conditional internal logging method to analyze the flow
throughout the spa application.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">spaLog</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> 
          <span class="k">if</span> <span class="p">(</span><span class="nx">debugging</span><span class="p">)</span> <span class="p">{</span> 
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span> 
          <span class="p">}</span> 
        <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>SPA framework uses extensively memoization (caching) internally, as
in catalog-like web apps, the likelyhood to browse back to a page is
very high. the same mechanisms are opened for app use, by making this
method public.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">memoize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">getterFunc</span><span class="p">,</span> <span class="nx">shouldMemoize</span><span class="p">)</span> <span class="p">{</span>                 
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">shouldMemoize</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span> 
            <span class="nx">shouldMemoize</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> 
          <span class="p">}</span>
          
          <span class="k">if</span> <span class="p">(</span><span class="nx">shouldMemoize</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>If the given key is an Array, casting to string will join its
elements [1,2] => &ldquo;1,2&rdquo; which is again sufficient for the key.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Buckets allow to separate key/values by semantical meaning of
the values in the application.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="nx">bucket</span> <span class="o">=</span> <span class="nx">bucket</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>            
            <span class="nx">objectsMemo</span><span class="p">[</span><span class="nx">bucket</span><span class="p">]</span> <span class="o">=</span> <span class="nx">objectsMemo</span><span class="p">[</span><span class="nx">bucket</span><span class="p">]</span> <span class="o">||</span> <span class="p">{};</span>        </pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Simply check if the memo key is defined on the bucket.
Set it if it does not, otherwise just return it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">objectsMemo</span><span class="p">[</span><span class="nx">bucket</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">spaLog</span><span class="p">(</span><span class="s1">&#39;(spa) mem miss: &#39;</span> <span class="o">+</span> <span class="nx">bucket</span> <span class="o">+</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">getterFunc</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">objectsMemo</span><span class="p">[</span><span class="nx">bucket</span><span class="p">][</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">getterFunc</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">spaLog</span><span class="p">(</span><span class="s1">&#39;(spa) mem hit: &#39;</span> <span class="o">+</span> <span class="nx">bucket</span> <span class="o">+</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">objectsMemo</span><span class="p">[</span><span class="nx">bucket</span><span class="p">][</span><span class="nx">key</span><span class="p">];</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Memoization is being skipped. If there was an existing memorized
value it should be invalidated/removed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">objectsMemo</span><span class="p">[</span><span class="nx">bucket</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">objectsMemo</span><span class="p">[</span><span class="nx">bucket</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">delete</span> <span class="nx">objectsMemo</span><span class="p">[</span><span class="nx">bucket</span><span class="p">][</span><span class="nx">key</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">getterFunc</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>We need a simple way of redirecting, by default to SPA hash bang
paths, buy also possibly with a different url method. This can for
instance be used in the response from the controller, by returning
a redirect option (see below).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">redirectToPath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">destinationHashPath</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">url</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">spaLog</span><span class="p">(</span><span class="s1">&#39;(spa) redirecting page: &#39;</span> <span class="o">+</span> <span class="nx">destinationHashPath</span><span class="p">);</span>
            <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s1">&#39;#!&#39;</span> <span class="o">+</span> <span class="nx">destinationHashPath</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">location</span> <span class="o">=</span> <span class="nx">url</span> <span class="o">+</span> <span class="p">(</span><span class="nx">destinationHashPath</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Not all browser support the onhashchange event. We must check
and if not supported fallback to alternative solution of polling.
The check is taken from Modernizr.js: documentMode logic from YUI to filter
out IE8 Compatibility Mode which gives false positives.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">isHashChangeSupported</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;onhashchange&#39;</span> <span class="k">in</span> <span class="nb">window</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
                 <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentMode</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentMode</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">);</span>
        <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Starts the SPA app router, not forgetting to process the current
hash path, so the SPA app jumps to the desired state &ndash; as in the
case of copy/pasting a whole url.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">startRouter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>                                                         
          <span class="k">if</span> <span class="p">(</span><span class="nx">isHashChangeSupported</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;hashchange&#39;</span><span class="p">,</span> <span class="nx">router</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>          
            <span class="nx">setInterval</span><span class="p">(</span><span class="nx">router</span><span class="p">,</span> <span class="nx">pollingInterval</span><span class="p">);</span>
          <span class="p">}</span>              
          <span class="nx">router</span><span class="p">();</span>                                                             
        <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>There are callbacks defined in multiple places in the router,
such as beforeRender, afterRender etc. The logic is the same,<br/>
so this method has been extracted out and generalized. There are
two levels of callbacks, one on the app level, which will run for
every controller, and there are callbacks on the controller level.
Controller callbacks have higher priority than the app ones as they
are closer to the logic code.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">runCallbacks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callbackName</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">controllers</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">controller</span><span class="p">][</span><span class="nx">callbackName</span><span class="p">])</span> <span class="p">{</span>                  
            <span class="p">(</span><span class="nx">controllers</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">controller</span><span class="p">][</span><span class="nx">callbackName</span><span class="p">])(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>                   
            <span class="nx">spaLog</span><span class="p">(</span><span class="s1">&#39;(spa) callback &#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">controller</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">callbackName</span> <span class="o">+</span> <span class="s1">&#39;()&#39;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">callbacks</span><span class="p">[</span><span class="nx">callbackName</span><span class="p">])</span> <span class="p">{</span>                                                     
            <span class="p">(</span><span class="nx">callbacks</span><span class="p">[</span><span class="nx">callbackName</span><span class="p">])(</span><span class="nx">request</span><span class="p">);</span>
            <span class="nx">spaLog</span><span class="p">(</span><span class="s1">&#39;(spa) callback &#39;</span> <span class="o">+</span> <span class="nx">callbackName</span> <span class="o">+</span> <span class="s1">&#39;()&#39;</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>SPA includes own simple dummy renderer. It can be redefined by calling
setRenderer() which will override this method. If there is a problem,
it should return null or false.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">templateRenderer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>          
          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">p</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">template</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;{{&#39;</span><span class="o">+</span><span class="nx">p</span><span class="o">+</span><span class="s1">&#39;}}&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">),</span> <span class="nx">data</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">template</span><span class="p">;</span>
        <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>@TODO: We need a preloader here of content. Currently not so dry.
  routeEntry = routeFor(urlpath)
  response = &hellip;
maybe even use it in the router</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          </pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Rendering, wrapping and setting of the template into the defined
application container. Wrapping is done so that the effort of
insertion as well deletion is minimal on the DOM. At the same time,
removal is done before setting so that the possible events are cleared,
preventing memory leaks.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">renderTemplate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">templateId</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">template</span>      <span class="o">=</span> <span class="nx">templatesMemo</span><span class="p">[</span><span class="nx">templateId</span><span class="p">],</span>
              <span class="nx">renderedView</span>  <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
              <span class="nx">cacheKey</span>      <span class="o">=</span> <span class="kc">null</span> <span class="p">;</span>

          <span class="nx">data</span>    <span class="o">=</span> <span class="nx">data</span>    <span class="o">||</span> <span class="p">{};</span>
          <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>The cache key is the template name for nonmutating views, where the
attribute cache is just set to true. To cache same views but for
different data, the attribute cache needs to be set to some data
that will uniquely identify it &ndash; e.g. ID of a product.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">cache</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">cacheKey</span> <span class="o">=</span> <span class="nx">templateId</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">cacheKey</span> <span class="o">=</span> <span class="nx">templateId</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">cache</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>Using the same memoization mechanism defined above, we will
cache the views that allow it, so they do not need to be re-rendered.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="nx">renderedView</span> <span class="o">=</span> <span class="nx">memoize</span><span class="p">(</span><span class="s1">&#39;spa__views&#39;</span><span class="p">,</span> <span class="nx">cacheKey</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">tmpView</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">tmpView</span> <span class="o">=</span> <span class="nx">templateRenderer</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>              
              <span class="k">if</span> <span class="p">(</span><span class="nx">tmpView</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s1">&#39;&lt;div id=&quot;spa__wrap&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">tmpView</span> <span class="o">+</span> <span class="s1">&#39;&lt;/div&gt;&#39;</span><span class="p">;</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;(spa) template could not be rendered &gt;&gt; &#39;</span> <span class="o">+</span> <span class="nx">templateId</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;(spa) template does not exist &gt;&gt; &#39;</span> <span class="o">+</span> <span class="nx">templateId</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">},</span> <span class="p">(</span><span class="nx">cacheKey</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">));</span>

          <span class="nx">containerElement</span><span class="p">.</span><span class="nx">empty</span><span class="p">().</span><span class="nx">html</span><span class="p">(</span><span class="nx">renderedView</span><span class="p">);</span>
        <span class="p">},</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>Parsing of the the current location hash and splitting it in
REST-like parameters which are returned.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">getParams</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">qs</span>       <span class="o">=</span> <span class="nx">str</span> <span class="o">||</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">,</span>
              <span class="nx">params</span>   <span class="o">=</span> <span class="p">{},</span>
              <span class="nx">qsArray</span><span class="p">,</span>
              <span class="nx">pair</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">qs</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\#\!/</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">qsArray</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
            <span class="k">while</span> <span class="p">(</span><span class="nx">qsArray</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">pair</span> <span class="o">=</span> <span class="nx">qsArray</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
              <span class="nx">params</span><span class="p">[</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">params</span><span class="p">;</span>
        <span class="p">},</span>

        </pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>Finding out the current route based on the information passed into
the hash, and returning the route entry with all its content back.
SPA routes start with &lsquo;#!&rsquo;&lsquo; &ndash; (hash bang).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">getRouteFor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">currentRoute</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>We will first try matching the root route, as with highest priority.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">hash</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^$|^#(?!\!).+/</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">currentRoute</span> <span class="o">=</span> <span class="nx">routes</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> 
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">hash</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\#\!.+/</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">routes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">currentRoute</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>                
              <span class="k">if</span> <span class="p">(</span><span class="nb">RegExp</span><span class="p">(</span><span class="nx">routes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">url</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">hash</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>                
                <span class="nx">currentRoute</span> <span class="o">=</span> <span class="nx">routes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> 
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">currentRoute</span><span class="p">;</span>
        <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>Router is invoked on every hash change. The route is parsed and
compared to predefined routes. Matching controller/action is then
called and passed parameters found in the hash.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">router</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">currentHash</span>       <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">||</span> <span class="s1">&#39;#!/&#39;</span><span class="p">,</span>
              <span class="nx">pollingAllowed</span>    <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
              <span class="nx">matchedRouteEntry</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
              <span class="nx">request</span>           <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
              <span class="nx">response</span>          <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>             
              <span class="nx">templateToRender</span>  <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>     
          

          <span class="k">if</span> <span class="p">(</span><span class="nx">pollingAllowed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">currentHash</span> <span class="o">!==</span> <span class="nx">previousHash</span><span class="p">))</span> <span class="p">{</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>In case of older browsers (IE6/7), where we use hash polling instead
of hash change events, polling needs to be terminated when we are
still on the same page, so unneccessary continous calls to the same
controller/action &amp; re-renderring is avoided.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="nx">pollingAllowed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="nx">matchedRouteEntry</span> <span class="o">=</span> <span class="nx">getRouteFor</span><span class="p">(</span><span class="nx">currentHash</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">matchedRouteEntry</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>The Route has not been recognized and we need to simulate 404.
The 404 template can be defined just as any other.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="nx">renderTemplate</span><span class="p">(</span><span class="s1">&#39;404&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nx">cache</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">path</span>           <span class="o">:</span> <span class="nx">currentHash</span><span class="p">,</span>
                <span class="nx">previousPath</span>   <span class="o">:</span> <span class="nx">previousHash</span><span class="p">,</span>                
                <span class="nx">params</span>         <span class="o">:</span> <span class="nx">getParams</span><span class="p">(</span><span class="nx">currentHash</span><span class="p">),</span>
                <span class="nx">previousParams</span> <span class="o">:</span> <span class="nx">previousParams</span><span class="p">,</span>
                <span class="nx">controller</span>     <span class="o">:</span> <span class="nx">matchedRouteEntry</span><span class="p">.</span><span class="nx">controller</span><span class="p">,</span>
                <span class="nx">action</span>         <span class="o">:</span> <span class="nx">matchedRouteEntry</span><span class="p">.</span><span class="nx">action</span> <span class="o">||</span> <span class="s1">&#39;handler&#39;</span>
              <span class="p">}</span>
              </pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>Run the callbacks defined in controller and on top level. Note
that the response doesn&rsquo;t exist yet so it is not passed here.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="nx">runCallbacks</span><span class="p">(</span><span class="s1">&#39;beforeFilter&#39;</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>
              </pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>Call the respective route&rsquo;s defined action with the params
fetched from the hash and pass in the previous ones for possible
context determination of the origin page if needed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="nx">response</span> <span class="o">=</span> <span class="p">(</span><span class="nx">controllers</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">controller</span><span class="p">][</span><span class="nx">request</span><span class="p">.</span><span class="nx">action</span><span class="p">])(</span><span class="nx">request</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>The afterFilter callback might be useful, if we are not concerned
whether the controller action responded at all, but still need
to do after controller processing.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="nx">runCallbacks</span><span class="p">(</span><span class="s1">&#39;afterFilter&#39;</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>If the controller action responed to hash parameters with data,
we can proceed to callbacks and rendering.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>The beforeRender callback might be useful for cleaning up the
previous view or detaching some events.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="nx">runCallbacks</span><span class="p">(</span><span class="s1">&#39;beforeRender&#39;</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>Assume the controller name for the template and using
single action controllers called &lsquo;handler&rsquo;.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="nx">templateToRender</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">controller</span><span class="p">;</span>
           </pre></div>
      </td>
    </tr>
    <tr id='section-36'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-36">&#182;</a>
        </div>
        <p>The controller can pass a name of the template to render
in the options  part of the response. Otherwise it can be
assumed by the action name.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">templateToRender</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span><span class="p">;</span>
                  <span class="k">delete</span> <span class="nx">response</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>                                    </pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>If action is passed, we will assume that action name
as template definition.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                  <span class="nx">templateToRender</span> <span class="o">+=</span> <span class="s1">&#39;__&#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">action</span><span class="p">;</span>
                <span class="p">}</span> 
                <span class="nx">response</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="nx">templateToRender</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>Some controller actions have no need of a rendered response.
Those can be popups for instance, triggered by hash changes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">renderNothing</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">spaLog</span><span class="p">(</span><span class="s1">&#39;(spa) template bypassed&#39;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-39'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-39">&#182;</a>
        </div>
        <p>Finally the template is rendered and the data and options given
from the action are passed into.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                  <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">templateToRender</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">options</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-40'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-40">&#182;</a>
        </div>
        <p>The afterRender callback is usually the place where DOM events
should be attached to the newly rendered html.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                  <span class="nx">runCallbacks</span><span class="p">(</span><span class="s1">&#39;afterRender&#39;</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-41'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-41">&#182;</a>
        </div>
        <p>We must ensure we are scrolling to the page top,
to simulate a well known page load behaviour</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body,html,document&quot;</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-42'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-42">&#182;</a>
        </div>
        <p>The response returned can ask for the app to redirect the page,
most likely to another SPA hash bang path, but also to another url.
Since this parameter runs late, after rendering, it can be nicely
combined with renderNothing option or special template.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">redirectTo</span><span class="p">)</span> <span class="p">{</span>                  
                  <span class="nx">redirectToPath</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">redirectTo</span><span class="p">);</span>
                <span class="p">}</span>

              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-43'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-43">&#182;</a>
        </div>
        <p>The route has been recognized, but the controller returned an
empty response probably the object does not exist in the
payload (like wrong id).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="nx">renderTemplate</span><span class="p">(</span><span class="s1">&#39;404&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nx">cache</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
              <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-44'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-44">&#182;</a>
        </div>
        <p>Previous hash and exploded params out of it are kept
so they can be given in the next request&rsquo;s hash, as a
context aid.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="nx">previousParams</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
              <span class="nx">previousHash</span>   <span class="o">=</span> <span class="nx">currentHash</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-45'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-45">&#182;</a>
        </div>
        <p>The handler of the route is finishing and polling is allowed
again &ndash; influences only older browsers.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="nx">pollingAllowed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>        
        <span class="p">};</span></pre></div>
      </td>
    </tr>
    <tr id='section-46'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-46">&#182;</a>
        </div>
        <p>Ensure there is a container of jQuery object / DOM element
to work with as a SPA. The rendering of pages will happen there.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">containerElement</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;(spa) container does not exist&#39;</span><span class="p">);</span>
    <span class="p">}</span>    
    </pre></div>
      </td>
    </tr>
    <tr id='section-47'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-47">&#182;</a>
        </div>
        <p>Views templates are fetched at initialization time and memoized into a
templatesMemo object from where they will be used instead from the DOM.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;script[type=&#39;text/html&#39;]&quot;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">el</span><span class="p">)</span> <span class="p">{</span>       
      <span class="kd">var</span> <span class="nx">templateEl</span>   <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">),</span>
          <span class="nx">templateName</span> <span class="o">=</span> <span class="nx">templateEl</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">templateName</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;spa__&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">templateName</span> <span class="o">=</span> <span class="nx">templateName</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">templatesMemo</span><span class="p">[</span><span class="nx">templateName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">templateEl</span><span class="p">.</span><span class="nx">html</span><span class="p">();</span>
    <span class="p">});</span></pre></div>
      </td>
    </tr>
    <tr id='section-48'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-48">&#182;</a>
        </div>
        <p>Expose public interfaces to the SPA object, so controllers/actions
and routes can be injected.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">return</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-49'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-49">&#182;</a>
        </div>
        <p>The helpers object exposes some of the internals which might be found
useful in the application, like templates, redirects and memoization.
It is recommended to extend this object with own methods via
the addHelpers defined below, so everything related to this SPA app
is kept in one object and place.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">helpers</span><span class="o">:</span> <span class="p">{</span>

        <span class="nx">redirectTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hashPath</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">redirectToPath</span><span class="p">(</span><span class="nx">hashPath</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">existsTemplate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">templateName</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">templatesMemo</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">templateName</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">getTemplate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">templateName</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">templatesMemo</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">templateName</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">templatesMemo</span><span class="p">[</span><span class="nx">templateName</span><span class="p">];</span>
          <span class="p">}</span>
        <span class="p">},</span>    

        <span class="nx">getMemoized</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">getterFunc</span><span class="p">,</span> <span class="nx">shouldMemoize</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">memoize</span><span class="p">(</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">getterFunc</span><span class="p">,</span> <span class="nx">shouldMemoize</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-50'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-50">&#182;</a>
        </div>
        <p>Method which will selectively turn debug logging on or off.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">setDebug</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>                                               
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">debugging</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-51'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-51">&#182;</a>
        </div>
        <p>If the default renderer (templating engine) won&rsquo;t do, a new one
can be set via this method. The signiture is function(template, data),
where template is a text/html file and data is of JSON format.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">setRenderer</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newRenderer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span><span class="p">(</span><span class="nx">templateRenderer</span><span class="p">);</span>
        <span class="nx">templateRenderer</span> <span class="o">=</span> <span class="nx">newRenderer</span><span class="p">;</span>
      <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-52'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-52">&#182;</a>
        </div>
        <p>With this method we can extend in bulk the helpers object below.
Adding single methods is also easy by directly defining them on
the spaApp.helpers.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">addHelpers</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newHelpers</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">helpers</span><span class="p">,</span> <span class="nx">newHelpers</span><span class="p">);</span>
      <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-53'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-53">&#182;</a>
        </div>
        <p>Controllers hold the main app logic/actions and are injected here,
by extending the private object <code>controllers</code>. The argument
<code>newControllers</code> is expected to be an object whose properties are
controllers of own properties which are actions.</p>

<p>Properties with the following names beforeRender, afterRender,
beforeFilter &amp; afterFilter define controller callbacks. To selectively
execute code in the callback for specific action, you can switch over
the property <code>action</code> of the request argument, containing the name
of the routed controller action.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">addControllers</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newControllers</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">controllers</span><span class="p">,</span> <span class="nx">newControllers</span><span class="p">);</span>
      <span class="p">},</span>      </pre></div>
      </td>
    </tr>
    <tr id='section-54'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-54">&#182;</a>
        </div>
        <p>Callbacks are methods which need to run after specific events in the code.
While controllers can defined own callback which are of higher priority,
here app level callbacks can be attached.</p>

<p>The argument <code>newCallback</code> is  expected to be an object whose properties are
callbacks with possible names beforeRender, afterRender, beforeFilter
&amp; afterFilter define callbacks. To selectively execute a callback for
specific action, we can switch over the name of the action present in
the request argument.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">addCallbacks</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newCallbacks</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">callbacks</span><span class="p">,</span> <span class="nx">newCallbacks</span><span class="p">);</span>
      <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-55'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-55">&#182;</a>
        </div>
        <p>Routes map url hash bang paths to controllers and their respective
actions. First added routes have higher priority as they are matched
via regular expressions. The argument <code>newRoutes</code> is expected to be an
array of object paths.</p>

<p>If action property is ommited above, the app will assume it&rsquo;s
called <code>handler</code>. You can define as many routes as needed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">addRoutes</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newRoutes</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">routes</span><span class="p">,</span> <span class="nx">newRoutes</span><span class="p">);</span>
      <span class="p">},</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-56'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-56">&#182;</a>
        </div>
        <p>Start the app by triggering the router to start listening for path
changes. The method has been wrapped in anonymous action for future changes.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">run</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">startRouter</span><span class="p">();</span>
      <span class="p">}</span>

    <span class="p">};</span>

  <span class="p">};</span>
<span class="p">})(</span> <span class="nx">jQuery</span> <span class="p">);</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
