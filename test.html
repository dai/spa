<!DOCTYPE html>
<html>
  <head>
    <title>SPA Test Page</title>  
    <style type="text/css">
      table { width: 100%; border-collapse:collapse; }
      table tr th { text-align: left; }      
      table tr.true { background-color: #afa; }
      table tr.false { background-color: #faa; }
    </style>

    <script type="text/javascript"> src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script type="text/javascript" src="jquery.spa.js"></script>
    <script type="text/javascript">
    // Mustache.js
    var Mustache;(function(p){"undefined"!==typeof module&&module.exports?module.exports=p:"function"===typeof define?define(p):Mustache=p})(function(){function p(a){return a.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function r(a){this.tail=this.string=a;this.pos=0}function l(a,b){this.view=a;this.parent=b;this.clearCache()}function g(){this.clearCache()}function w(a){for(var b=a[3],c=b,d;(d=a[4])&&d.length;)a=d[d.length-1],c=a[3];return[b,c]}function s(a){function b(a,b,f){if(!c[a]){var e=s(b);c[a]=function(a,b){return e(a,b,f)}}return c[a]}var c={};return function(c,h,f){for(var e="",k,j,i=0,g=a.length;i<g;++i)switch(k=a[i],k[0]){case "#":j=f.slice.apply(f,w(k));e+=c._section(k[1],h,j,b(i,k[4],f));break;case "^":e+=c._inverted(k[1],h,b(i,k[4],f));break;case ">":e+=c._partial(k[1],h);break;case "&":e+=c._name(k[1],h);break;case "name":e+=c._escaped(k[1],h);break;case "text":e+=k[1]}return e}}function t(a){if(2!==a.length)throw Error("Invalid tags: "+a.join(" "));return[RegExp(p(a[0])+"\\s*"),RegExp("\\s*"+p(a[1]))]}var j={name:"mustache.js",version:"0.7.0",tags:["{{","}}"]};j.Scanner=r;j.Context=l;j.Writer=g;var x=/\s*/,y=/\s+/,z=/\S/,u=/\s*=/,A=/\s*\}/,B=/#|\^|\/|>|\{|&|=|!/,v=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},C={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};j.escape=function(a){return String(a).replace(/[&<>"'\/]/g,function(a){return C[a]})};r.prototype.eos=function(){return""===this.tail};r.prototype.scan=function(a){return(a=this.tail.match(a))&&0===a.index?(this.tail=this.tail.substring(a[0].length),this.pos+=a[0].length,a[0]):""};r.prototype.scanUntil=function(a){var b=this.tail.search(a);switch(b){case -1:a=this.tail;this.pos+=this.tail.length;this.tail="";break;case 0:a="";break;default:a=this.tail.substring(0,b),this.tail=this.tail.substring(b),this.pos+=b}return a};l.make=function(a){return a instanceof l?a:new l(a)};l.prototype.clearCache=function(){this._cache={}};l.prototype.push=function(a){return new l(a,this)};l.prototype.lookup=function(a){var b=this._cache[a];if(!b){if("."===a)b=this.view;else for(var c=this;c;){if(0<a.indexOf("."))for(var d=a.split("."),h=0,b=c.view;b&&h<d.length;)b=b[d[h++]];else b=c.view[a];if(null!=b)break;c=c.parent}this._cache[a]=b}"function"===typeof b&&(b=b.call(this.view));return b};g.prototype.clearCache=function(){this._cache={};this._partialCache={}};g.prototype.compile=function(a,b){var c=this._cache[a];c||(c=j.parse(a,b),c=this._cache[a]=this.compileTokens(c,a));return c};g.prototype.compilePartial=function(a,b,c){b=this.compile(b,c);return this._partialCache[a]=b};g.prototype.compileTokens=function(a,b){var c=s(a),d=this;return function(a,f){if(f)if("function"===typeof f)d._loadPartial=f;else for(var e in f)d.compilePartial(e,f[e]);return c(d,l.make(a),b)}};g.prototype.render=function(a,b,c){return this.compile(a)(b,c)};g.prototype._section=function(a,b,c,d){a=b.lookup(a);switch(typeof a){case "object":if(v(a)){for(var c="",h=0,f=a.length;h<f;++h)c+=d(this,b.push(a[h]));return c}return a?d(this,b.push(a)):"";case "function":var e=this;return a.call(b.view,c,function(a){return e.render(a,b)})||"";default:if(a)return d(this,b)}return""};g.prototype._inverted=function(a,b,c){a=b.lookup(a);return!a||v(a)&&0===a.length?c(this,b):""};g.prototype._partial=function(a,b){!(a in this._partialCache)&&this._loadPartial&&this.compilePartial(a,this._loadPartial(a));var c=this._partialCache[a];return c?c(b):""};g.prototype._name=function(a,b){var c=b.lookup(a);"function"===typeof c&&(c=c.call(b.view));return null==c?"":String(c)};g.prototype._escaped=function(a,b){return j.escape(this._name(a,b))};j.parse=function(a,b){for(var b=b||j.tags,c=t(b),d=new r(a),h=[],f=[],e=!1,k=!1,g,i,m;!d.eos();){g=d.pos;if(m=d.scanUntil(c[0]))for(var l=0,q=m.length;l<q;++l)if(i=m.charAt(l),RegExp.prototype.test.call(z,i)?k=!0:f.push(h.length),h.push(["text",i,g,g+1]),g+=1,"\n"===i){if(e&&!k)for(;f.length;)h.splice(f.pop(),1);else f=[];k=e=!1}g=d.pos;if(!d.scan(c[0]))break;e=!0;i=d.scan(B)||"name";d.scan(x);"="===i?(m=d.scanUntil(u),d.scan(u),d.scanUntil(c[1])):"{"===i?(m=RegExp("\\s*"+p("}"+b[1])),m=d.scanUntil(m),d.scan(A),d.scanUntil(c[1]),i="&"):m=d.scanUntil(c[1]);if(!d.scan(c[1]))throw Error("Unclosed tag at "+d.pos);h.push([i,m,g,d.pos]);if("name"===i||"{"===i||"&"===i)k=!0;"="===i&&(b=m.split(y),c=t(b))}for(var n,d=0;d<h.length;++d)c=h[d],n&&"text"===n[0]&&"text"===c[0]?(n[1]+=c[1],n[3]=c[3],h.splice(d--,1)):n=c;e=n=[];c=[];for(f=0;f<h.length;++f)switch(d=h[f],d[0]){case "#":case "^":d[4]=[];c.push(d);e.push(d);e=d[4];break;case "/":if(0===c.length)throw Error("Unopened section: "+d[1]);e=c.pop();if(e[1]!==d[1])throw Error("Unclosed section: "+e[1]);e=0<c.length?c[c.length-1][4]:n;break;default:e.push(d)}if(e=c.pop())throw Error("Unclosed section: "+e[1]);return n};var q=new g;j.clearCache=function(){return q.clearCache()};j.compile=function(a,b){return q.compile(a,b)};j.compilePartial=function(a,b,c){return q.compilePartial(a,b,c)};j.compileTokens=function(a,b){return q.compileTokens(a,b)};j.render=function(a,b,c){return q.render(a,b,c)};j.to_html=function(a,b,c,d){a=j.render(a,b,c);if("function"===typeof d)d(a);else return a};return j}());
    </script>

    <!-- the main template, listing test results -->
    <script type="text/html" id="spa__tests__index">
      <h1>SPA Tests</h1>
      <p>
        These are simple tests for development purposes. 
        <br/>
        The page is constructed and rendered with SPA. 
        It is normal to see red flashes.
      </p>
      <table>
        <thead>
          <tr><th>Id</th><th>Description</th><th>Result</th></tr>
        </thead>
        {{#tests}}
        <tr class="{{result}}"><td>#{{id}}</td><td>{{name}}</td><td>{{#result}}ok{{/result}}{{^result}}fail{{/result}}</td></tr>
        {{/tests}}
      </table>
    </script>

    <!-- The 404 page, please do not change, content lookup is done-->
    <script type="text/html" id="spa__404">404</script>
  </head>

  <body>
    <!-- this is the main content area where templates get rendered -->
    <div id="spa_main">
      Main content area that will be replaced
    </div>

    <!-- 
        tests for SPA are written in SPA, it gets really curly down there,
        trying several use cases and asserting results. What follows is not
        a way how to write SPA apps, but an extreme push of core features,
        with additional raping through overriding.
      -->
    <script type="text/javascript">
      var spaApp,
          timer         = null,   // for testing timed actions, one shot only
          hashTest      = false,  // this global will check flows through hash changes
          callbacksTest = '',     // we'll capture the order of callbacks here
          not_found     = null;   // for testing 404 page

      $(function() {
        spaApp = $('#spa_main').spa();

        spaApp.addHelpers({

          simpleValue: function() {
            return 'irrelevant';
          },

          getTests: function () {
            return {
              tests: [
                { 
                  id: 0, 
                  name: "debug mode (check console)", 
                  result: (function() { 
                    return spaApp.setDebug(true); 
                  })()
                },


                { 
                  id: 1, 
                  name: "loading, run, repetitive run", 
                  result: (function() { 
                    return spaApp.isRunning() && !spaApp.run(); 
                  })()
                },


                {
                  id: 2, 
                  name: "templates", 
                  result: (function() { 
                    return ((typeof spaApp.helpers.getTemplate('tests__index') === 'string') &&
                            (typeof spaApp.helpers.getTemplate('tests__nonexisting') === 'undefined'));
                  })()
                },


                {
                  id: 3, 
                  name: "memoization, conditional value, conditional method", 
                  result: (function() { 
                    var result     = false, 
                        testerFunc = function(useMemo, condFunc) {                          
                          return spaApp.helpers.getMemoized('test', 'memoization', 
                            function() { 
                              result = !result; 
                              return result; 
                            }, 
                            useMemo, condFunc);
                        };

                    return testerFunc() && testerFunc() && testerFunc() && 
                           !testerFunc(false) && testerFunc(false) && !testerFunc(false) &&
                           testerFunc(true, function(){ return false; }) &&
                           !testerFunc(true, function(){ return false; });
                  })()
                },


                {
                  id: 4, 
                  name: "hash listeners, routing, redirection, rendering, rendering nothing", 
                  result: hashTest
                },


                {
                  id: 5, 
                  name: "callbacks, order, overriding",                  
                  result: (callbacksTest === "<bfBF><afAF><brBR><arAR><bfBF><afAF><bfBF><afAF><brBR><arAR><bfBF>")
                },                             


                { id: 6,
                  name: "defaul renderer, change, custom renderer with mustache, iteration",
                  result: (function() {
                    var basicRenderer = (spaApp.helpers.render("test") === "test") &&
                                        (spaApp.helpers.render("test-{{v}}", {v:'ok'}) === "test-ok");

                    spaApp.setRenderer(function(template, data, templates) {
                      return Mustache.render(template, data, templates);
                    });

                    return basicRenderer && (spaApp.helpers.render("test") === "test") &&
                           (spaApp.helpers.render("test-{{v}}", {v:'ok'}) === "test-ok") &&
                           (spaApp.helpers.render("{{#a}}{{i}}{{/a}}", {a:[{i:1},{i:2}]}) === "12");
                  })()
                },
                

                {
                  id: 7,
                  name: "helper, helper override test",
                  result: function() {
                    spaApp.addHelpers({
                      simpleValue: function() { return "test"; }
                    });
                    return (spaApp.helpers.simpleValue() === "test");
                  }
                },


                {
                  id: 8, 
                  name: "404 page, rendering, container contents, browsing",                  
                  result: not_found
                },                             

              ]
            };
          }
        });



        spaApp.addControllers({
          tests: {

            beforeFilter: function(request){
              callbacksTest += '<bf';
            },

            afterFilter: function(request, response){
              callbacksTest += '<af';
            },

            beforeRender: function(request, response){
              callbacksTest += '<br';
            },

            afterRender: function(request, response){
              callbacksTest += '<ar';
            },

            index: function(request) {              
              if (timer === null) {
                timer = setTimeout(function(){ 
                          spaApp.helpers.redirectTo('/hashtest');
                          setTimeout(function(){
                            spaApp.helpers.redirectTo('/unknown');                              
                              setTimeout(function(){              
                                not_found = ($('#spa_main').text() === '404');                  
                                spaApp.helpers.redirectTo('/');
                              }, 200);
                          }, 200);
                        }, 200);
              }
              return {
                data: spaApp.helpers.getTests(),
                options: {
                  // caching of the data response must be disabled so we can
                  // refresh the page for some tests that require a page bounce.
                  cache: false
                }
              };
            },

            hashtest: function(request) {
              hashTest = true;
              return {
                options: {
                  renderNothing: true,
                  redirectTo: '/'
                }
              };
            }
          }
        });

        
        // we will attach some callbacks and test their order of execution
        // as compared to the overriden ones, and the ones in the controller.
        spaApp.addCallbacks({
          beforeFilter: function(request) {
            callbacksTest += '>';
          },
          afterFilter: function(request, response) {
            callbacksTest += '>';

          },

          beforeRender: function(request, response) {
            callbacksTest += '>';            
          },

          afterRender: function(request, response) {
            callbacksTest += '>';
          }
        });


        // Override a callback, will execute before the one above, adding
        // one character in front, to be equal to the others.    
        spaApp.addCallbacks({
          beforeFilter: function(request) {
            callbacksTest += 'BF';            
          },

          afterFilter: function(request, response) {
            callbacksTest += 'AF';
          },

          beforeRender: function(request, response) {
            callbacksTest += 'BR';
          },

          afterRender: function(request, response) {
            callbacksTest += 'AR';
          }
        });



        spaApp.addRoutes([
          { url: '^/hashtest$', controller: 'tests', action: 'hashtest' },
          { url: '^/?$',        controller: 'tests', action: 'index' }
        ]);

        spaApp.run();
      });
    </script>

  </body>
</html>
